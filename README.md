

# Cluster Secure MVP (Client + Volunteer Workers)

This project runs distributed compute tasks where:

- A client submits jobs from CLI or web UI.
- Volunteers join from a browser worker page.
- Workers receive tasks over WebSocket and return results.

Supported task types:

- `add` (`a + b`)
- `run_js` (custom JavaScript + JSON args)

`run_js` tasks are accepted only when server-signed and worker-verified.

## 1. Local Development

### Requirements

- Node.js 20+

### Install

```bash
npm install
```

### Generate local secrets and signing keys

```bash
npm run gen:secrets
```

Copy values into `.env` (from `.env.example`).

### Run

```bash
npm run start
```

Server listens on `PORT` (default `8080`).

## 2. Auth and Signing Model

### Client auth

All protected `/api/*` routes require:

`Authorization: Bearer <CLIENT_API_KEY>`

You can also authenticate with a mnemonic phrase that represents the same key bytes.

### Worker auth

Workers must connect using a signed invite token:

`/worker?invite=<token>`

For easier manual typing, invite links can also be shortened:

`/j/<short_code>`

Or generated as easy word phrases:

`/p/<word>-<word>-<word>-<word>`

Short/phrase invite aliases are stored in memory for MVP and reset on server restart.

Invite tokens are HMAC-signed by `WORKER_INVITE_SECRET` and expire by TTL.
By default (`WORKER_INVITE_REQUIRE_LATEST=1`), only the most recently generated invite is accepted; older invites are rejected as stale.

### Signed custom jobs

For `run_js` jobs, server signs assignment payloads with RSA private key:

- `JOB_SIGNING_PRIVATE_KEY_B64` (PKCS8 DER, base64)
- `JOB_SIGNING_PUBLIC_KEY_B64` (SPKI DER, base64)

Worker fetches public key from `/api/public-config`, verifies signature, checks expiry/nonce, then executes.

Unsigned or tampered custom code is rejected.

## 3. CLI Usage

### Submit add job

```bash
node cli/cluster-cli.js submit --a 2 --b 2 --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY>
```

### Submit custom JS job

```bash
node cli/cluster-cli.js run-js --file ./task.js --args-json '{"a":2,"b":2}' --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY>
```

Inline code is also supported:

```bash
node cli/cluster-cli.js run-js --code "return (args.a||0)+(args.b||0)" --args-json '{"a":2,"b":2}'
```

### Pi examples: single vs sharded

Files:

- `examples/pi-single.js` (single worker)
- `examples/pi-sharded.js` (cluster sharded, uses `globalThis.__BRAIN__?.units`)

Use `pi-single.js` when you want one worker to do all work.

Use `pi-sharded.js` when you want cluster fan-out:

- in web UI, set `total units` and `units per shard`
- reducer `sum`
- sum fields `hits,samples`

If shard fields are left empty, run mode auto-resolves to `single`.
For `run_js`, reducers read numeric fields from top-level result or `returnValue`.
If sharded mode is requested but fewer than 2 workers are connected, server auto-runs the job as a single task.
Shard settings are advisory-tuned only (your explicit `units per shard` is preserved):

- minimum units per shard (`SHARD_MIN_UNITS`, default `1`)
- shard cap per worker (`SHARD_MAX_PER_WORKER`, default `200`)
- absolute shard cap (`SHARD_ABSOLUTE_MAX`, default `9007199254740991`)

Then compute `pi ~= 4 * (aggregate.hits / aggregate.samples)`.

### Generate worker invite

```bash
node cli/cluster-cli.js invite --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY> --ttl-sec 3600
```

CLI prints full, phrase, and short invite URLs (phrase is preferred for manual typing with stronger entropy).

Optional QR output:

```bash
node cli/cluster-cli.js invite --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY> --qr
node cli/cluster-cli.js invite --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY> --qr-file ./worker-invite.png
```

You can set `CLIENT_API_KEY` env var and omit `--client-token`.

### Convert client token <-> mnemonic

```bash
node cli/cluster-cli.js token-mnemonic --token <CLIENT_API_KEY>
node cli/cluster-cli.js token-mnemonic --env-file ./.env
node cli/cluster-cli.js mnemonic-token --phrase "word1 word2 ... word24" --format base64url
```

## 4. Web Usage

### Client page

- `https://harmonizer.cc/cluster/client`
- Enter client token or mnemonic phrase
- Submit `a + b` jobs
- Submit custom JS jobs (`code + args + timeout`)
- Generate phrase + short + full worker invite URLs with QR code preview/download (QR/clipboard prefer phrase URL)

### Worker page

- Open invite URL generated by client
- Worker auto-generates `workerId` in localStorage
- Verifies signed custom jobs before executing

## 5. VPS Deployment Under Existing Domain (`harmonizer.cc/cluster`)

If you already cloned the repo on the VPS and you are inside that clone, run:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh
```

What it does:

- installs required packages (`nginx`, `nodejs`, `ufw`, optional `fail2ban`)
- deploys from your local clone by default (`--source-mode auto` resolves to local)
- pulls latest local git changes by default when deploying from a local repo (`--pull-local-source 1`)
- writes app `.env` with generated secrets and RSA signing keys if missing
- rotates `CLIENT_API_KEY` by default and prints both key + mnemonic at the end (`--rotate-client-key 1`)
- creates a Python virtualenv (`APP_DIR/.venv`) and upgrades pip tooling
- installs production dependencies (`npm ci --omit=dev`)
- creates and enables `systemd` service (`cluster-app`)
- auto-detects proxy mode:
  - host nginx config in `/etc/nginx/...`, or
  - docker proxy container (`caddy`/`nginx`) and patches mounted config
- reloads nginx and runs health checks
- writes a deployment status report to `APP_DIR/deploy-status.txt`

Useful flags:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh \
  --source-mode local \
  --source-dir /root/your-clone \
  --pull-local-source 1 \
  --proxy-mode auto \
  --rotate-client-key 1 \
  --worker-invite-phrase-words 8 \
  --domain harmonizer.cc \
  --base-path /cluster
```

If auto-detection picks the wrong proxy container, pass it explicitly:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh --proxy-mode docker-proxy --docker-proxy-container <container_name>
```

If `/cluster/client` is still 404 after deploy, check who owns `:443` on VPS and force that mode:

```bash
sudo ss -tulpn | grep ':443'
```

## 6. Security Controls Included

- `helmet` headers
- API rate limiting (`express-rate-limit`)
- request body size cap
- WebSocket payload cap (`WS_MAX_PAYLOAD`)
- per-IP active WebSocket connection cap
- per-connection WebSocket message rate cap
- strict WS message schema handling
- signed custom job envelopes (`RS256`) with expiry and anti-replay nonce checks
- worker execution timeout for custom jobs

## 7. Environment Variables

See `.env.example`.

Primary:

- `CLIENT_API_KEY`
- `WORKER_INVITE_SECRET`
- `JOB_SIGNING_PRIVATE_KEY_B64`
- `JOB_SIGNING_PUBLIC_KEY_B64`
- `PORT`
- `HOST`
- `TRUST_PROXY`
- `BASE_PATH`

Custom job tuning:

- `SIGNED_JOB_TTL_SEC`
- `CUSTOM_JOB_MAX_CODE_BYTES`
- `CUSTOM_JOB_MAX_ARGS_BYTES`
- `CUSTOM_JOB_MAX_RESULT_BYTES`
- `CUSTOM_JOB_MIN_TIMEOUT_MS`
- `CUSTOM_JOB_MAX_TIMEOUT_MS`
- `CUSTOM_JOB_DEFAULT_TIMEOUT_MS`

Timeout behavior:

- `timeoutMs=0` means no timeout.
- Any non-negative safe integer timeout is accepted.

Short invite tuning:

- `SHORT_INVITE_CODE_LENGTH` (default `7`, min `4`, max `16`)
- `SHORT_INVITE_MAX_ACTIVE` (default `50000`)
- `WORKER_INVITE_PHRASE_WORDS` (default `8`, min `3`, max `8`)

Rate/shard safety tuning:

- `API_RATE_LIMIT_WINDOW_MS` (default `60000`)
- `API_RATE_LIMIT_MAX` (default `1200`)
- `WS_MAX_MESSAGES_PER_WINDOW` (default `9007199254740991`)
- `SHARD_MIN_UNITS` (default `1`)
- `SHARD_MAX_PER_WORKER` (default `200`)
- `SHARD_ABSOLUTE_MAX` (default `9007199254740991`)
- `WORKER_MAX_CONCURRENT_JOBS` (default `8`)

## 8. Key Endpoints

When `BASE_PATH` is set (for example `/cluster`), prefix all endpoints with it.

- `GET /health`
- `GET /client`
- `GET /worker`
- `GET /j/:code` (short invite redirect)
- `GET /p/:phraseSlug` (phrase invite redirect)
- `GET /api/public-config`
- `GET /api/auth/check` (token required)
- `POST /api/invites/worker` (token required)
- `POST /api/jobs` (token required)
- `POST /api/jobs/run-js` (token required)
- `GET /api/jobs/:jobId` (token required)
- `GET /api/workers` (token required)

## 9. Benchmarking (Local vs Cluster)

Use the benchmark suite to compare:

- jobs/minute
- units/second
- cluster speedup vs local baseline

Files:

- `benchmarks/cluster_benchmark_suite.js` (single script used for both local and cluster)
- `benchmarks/presets.json`
- `scripts/benchmark-harness.js`

Quick examples:

```bash
# Local baseline only
node scripts/benchmark-harness.js --mode local --runs 1 --scale 1

# Cluster only
node scripts/benchmark-harness.js --mode cluster --runs 1 --scale 1 --host https://harmonizerlabs.cc --client-token "<token>"

# Direct comparison in one run
node scripts/benchmark-harness.js --mode both --runs 1 --scale 1 --host https://harmonizerlabs.cc --client-token "<token>"
```

Single one-shot benchmark (all tests in one submitted job):

```bash
node scripts/benchmark-harness.js --mode both --benchmarks suite --runs 1 --target-suite-seconds 60 --host https://harmonizerlabs.cc --client-token "<token>"
```

Longer stress run example:

```bash
node scripts/benchmark-harness.js --mode both --target-suite-seconds 150 --runs 1 --host https://harmonizerlabs.cc --client-token "<token>"
```

For detailed benchmark descriptions and reducer mapping, see `benchmarks/README.md`.
