# Cluster Secure MVP (Client + Volunteer Workers)

This project runs distributed `a + b` tasks where:

- A client submits jobs from CLI or web UI.
- Volunteers join from a browser worker page.
- Workers receive tasks over WebSocket and return results.

This version is hardened for internet deployment:

- Client API token auth
- Signed, expiring worker invite links
- HTTP and WebSocket rate limits
- Strict message and payload validation
- nginx + systemd deployment support for existing-domain subpath hosting

## 1. Local Development

### Requirements

- Node.js 20+

### Install

```bash
npm install
```

### Generate local secrets

```bash
npm run gen:secrets
```

Copy values into `.env` (from `.env.example`).

### Run

```bash
npm run start
```

Server listens on `PORT` (default `8080`).

## 2. Auth Model

### Client auth

All `/api/*` routes require `Authorization: Bearer <CLIENT_API_KEY>`.

### Worker auth

Workers must connect using a signed invite token in URL:

`/worker?invite=<token>`

Invite tokens are:

- HMAC-signed with `WORKER_INVITE_SECRET`
- time-limited (`WORKER_INVITE_TTL_SEC`, default 3600s)

## 3. CLI Usage

### Submit job

```bash
node cli/cluster-cli.js submit --a 2 --b 2 --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY>
```

### Generate worker invite

```bash
node cli/cluster-cli.js invite --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY> --ttl-sec 3600
```

You can also set `CLIENT_API_KEY` env var and omit `--client-token`.

## 4. Web Usage

### Client page

- `https://harmonizer.cc/cluster/client`
- Enter client token
- Submit jobs
- Generate worker invite URLs

### Worker page

- Open invite URL generated by client
- Worker auto-generates `workerId` in localStorage

## 5. VPS Deployment Under Existing Domain (`harmonizer.cc/cluster`)

This repo includes an idempotent root-level VPS setup script:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh
```

What it does:

- installs required packages (`nginx`, `nodejs`, `ufw`, optional `fail2ban`)
- pulls this repo to a separate folder (`/home/harmonizer/apps/cluster` by default)
- writes app `.env` with generated secrets if missing
- installs production dependencies (`npm ci --omit=dev`)
- creates and enables a hardened `systemd` service (`cluster-app`)
- adds nginx location routing for `harmonizer.cc/cluster` without replacing existing root site
- reloads nginx and runs health checks

Default URLs after setup:

- Client: `https://harmonizer.cc/cluster/client`
- Worker: `https://harmonizer.cc/cluster/worker?invite=...`

Useful flags:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh \
  --repo-url https://github.com/ORG/REPO.git \
  --repo-branch light \
  --domain harmonizer.cc \
  --base-path /cluster \
  --nginx-site-conf /etc/nginx/sites-enabled/harmonizer.cc
```

## 6. Security Controls Included

- `helmet` headers
- API rate limiting (`express-rate-limit`)
- request body size cap
- WebSocket payload cap (`WS_MAX_PAYLOAD`)
- per-IP active WebSocket connection cap
- per-connection WebSocket message rate cap
- strict WS message schema handling
- no `eval`, no arbitrary code execution
- typed task payloads only (`op=add`)

## 7. Environment Variables

See `.env.example` for all tunables.

Primary:

- `CLIENT_API_KEY`
- `WORKER_INVITE_SECRET`
- `WORKER_INVITE_TTL_SEC`
- `PORT`
- `HOST`
- `TRUST_PROXY`
- `BASE_PATH`

## 8. Key Endpoints

When `BASE_PATH` is set (for example `/cluster`), prefix all endpoints with it.

- `GET /health`
- `GET /client`
- `GET /worker`
- `GET /api/auth/check` (token required)
- `POST /api/invites/worker` (token required)
- `POST /api/jobs` (token required)
- `GET /api/jobs/:jobId` (token required)
- `GET /api/workers` (token required)

## 9. Host/DNS Notes

For this subpath deployment model, the existing `harmonizer.cc` DNS and TLS setup stays in place. The script only adds a new nginx location block for `/cluster`.

