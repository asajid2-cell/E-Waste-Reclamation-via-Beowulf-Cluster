# Cluster Secure MVP (Client + Volunteer Workers)

This project runs distributed compute tasks where:

- A client submits jobs from CLI or web UI.
- Volunteers join from a browser worker page.
- Workers receive tasks over WebSocket and return results.

Supported task types:

- `add` (`a + b`)
- `run_js` (custom JavaScript + JSON args)

`run_js` tasks are accepted only when server-signed and worker-verified.

## 1. Local Development

### Requirements

- Node.js 20+

### Install

```bash
npm install
```

### Generate local secrets and signing keys

```bash
npm run gen:secrets
```

Copy values into `.env` (from `.env.example`).

### Run

```bash
npm run start
```

Server listens on `PORT` (default `8080`).

## 2. Auth and Signing Model

### Client auth

All protected `/api/*` routes require:

`Authorization: Bearer <CLIENT_API_KEY>`

### Worker auth

Workers must connect using a signed invite token:

`/worker?invite=<token>`

Invite tokens are HMAC-signed by `WORKER_INVITE_SECRET` and expire by TTL.

### Signed custom jobs

For `run_js` jobs, server signs assignment payloads with RSA private key:

- `JOB_SIGNING_PRIVATE_KEY_B64` (PKCS8 DER, base64)
- `JOB_SIGNING_PUBLIC_KEY_B64` (SPKI DER, base64)

Worker fetches public key from `/api/public-config`, verifies signature, checks expiry/nonce, then executes.

Unsigned or tampered custom code is rejected.

## 3. CLI Usage

### Submit add job

```bash
node cli/cluster-cli.js submit --a 2 --b 2 --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY>
```

### Submit custom JS job

```bash
node cli/cluster-cli.js run-js --file ./task.js --args-json '{"a":2,"b":2}' --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY>
```

Inline code is also supported:

```bash
node cli/cluster-cli.js run-js --code "return (args.a||0)+(args.b||0)" --args-json '{"a":2,"b":2}'
```

### Generate worker invite

```bash
node cli/cluster-cli.js invite --host https://harmonizer.cc/cluster --client-token <CLIENT_API_KEY> --ttl-sec 3600
```

You can set `CLIENT_API_KEY` env var and omit `--client-token`.

## 4. Web Usage

### Client page

- `https://harmonizer.cc/cluster/client`
- Enter client token
- Submit `a + b` jobs
- Submit custom JS jobs (`code + args + timeout`)
- Generate worker invite URLs

### Worker page

- Open invite URL generated by client
- Worker auto-generates `workerId` in localStorage
- Verifies signed custom jobs before executing

## 5. VPS Deployment Under Existing Domain (`harmonizer.cc/cluster`)

If you already cloned the repo on the VPS and you are inside that clone, run:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh
```

What it does:

- installs required packages (`nginx`, `nodejs`, `ufw`, optional `fail2ban`)
- deploys from your local clone by default (`--source-mode auto` resolves to local)
- writes app `.env` with generated secrets and RSA signing keys if missing
- creates a Python virtualenv (`APP_DIR/.venv`) and upgrades pip tooling
- installs production dependencies (`npm ci --omit=dev`)
- creates and enables `systemd` service (`cluster-app`)
- adds nginx location routing for `harmonizer.cc/cluster` without replacing root site
- reloads nginx and runs health checks
- writes a deployment status report to `APP_DIR/deploy-status.txt`

Useful flags:

```bash
sudo bash deploy/setup_harmonizer_cluster_vps.sh \
  --source-mode local \
  --source-dir /root/your-clone \
  --domain harmonizer.cc \
  --base-path /cluster
```

## 6. Security Controls Included

- `helmet` headers
- API rate limiting (`express-rate-limit`)
- request body size cap
- WebSocket payload cap (`WS_MAX_PAYLOAD`)
- per-IP active WebSocket connection cap
- per-connection WebSocket message rate cap
- strict WS message schema handling
- signed custom job envelopes (`RS256`) with expiry and anti-replay nonce checks
- worker execution timeout for custom jobs

## 7. Environment Variables

See `.env.example`.

Primary:

- `CLIENT_API_KEY`
- `WORKER_INVITE_SECRET`
- `JOB_SIGNING_PRIVATE_KEY_B64`
- `JOB_SIGNING_PUBLIC_KEY_B64`
- `PORT`
- `HOST`
- `TRUST_PROXY`
- `BASE_PATH`

Custom job tuning:

- `SIGNED_JOB_TTL_SEC`
- `CUSTOM_JOB_MAX_CODE_BYTES`
- `CUSTOM_JOB_MAX_ARGS_BYTES`
- `CUSTOM_JOB_MAX_RESULT_BYTES`
- `CUSTOM_JOB_MIN_TIMEOUT_MS`
- `CUSTOM_JOB_MAX_TIMEOUT_MS`
- `CUSTOM_JOB_DEFAULT_TIMEOUT_MS`

## 8. Key Endpoints

When `BASE_PATH` is set (for example `/cluster`), prefix all endpoints with it.

- `GET /health`
- `GET /client`
- `GET /worker`
- `GET /api/public-config`
- `GET /api/auth/check` (token required)
- `POST /api/invites/worker` (token required)
- `POST /api/jobs` (token required)
- `POST /api/jobs/run-js` (token required)
- `GET /api/jobs/:jobId` (token required)
- `GET /api/workers` (token required)
